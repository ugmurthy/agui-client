var $=Object.defineProperty,k=Object.defineProperties;var B=Object.getOwnPropertyDescriptors;var j=Object.getOwnPropertySymbols;var J=Object.prototype.hasOwnProperty,q=Object.prototype.propertyIsEnumerable;var z=(u,e,t)=>e in u?$(u,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):u[e]=t,x=(u,e)=>{for(var t in e||(e={}))J.call(e,t)&&z(u,t,e[t]);if(j)for(var t of j(e))q.call(e,t)&&z(u,t,e[t]);return u},_=(u,e)=>k(u,B(e));import{EventType as S}from"@ag-ui/core";import{mergeMap as V}from"rxjs/operators";var v=u=>{if(typeof structuredClone=="function")return structuredClone(u);try{return JSON.parse(JSON.stringify(u))}catch(e){return x({},u)}};import{applyPatch as W}from"fast-json-patch";import Y from"untruncate-json";var I=(...u)=>{let[e,t]=u,n=v(e.messages),r=v(e.state),o,i=c=>[v(c)],s=()=>[];return t.pipe(V(c=>{var R;switch(c.type){case S.TEXT_MESSAGE_START:{let{messageId:E,role:p}=c,l={id:E,role:p,content:""};return n.push(l),i({messages:n})}case S.TEXT_MESSAGE_CONTENT:{let{delta:E}=c,p=n[n.length-1];return p.content=p.content+E,i({messages:n})}case S.TEXT_MESSAGE_END:return s();case S.TOOL_CALL_START:{let{toolCallId:E,toolCallName:p,parentMessageId:l}=c,d;return l&&n.length>0&&n[n.length-1].id===l?d=n[n.length-1]:(d={id:l||E,role:"assistant",toolCalls:[]},n.push(d)),(R=d.toolCalls)!=null||(d.toolCalls=[]),d.toolCalls.push({id:E,type:"function",function:{name:p,arguments:""}}),i({messages:n})}case S.TOOL_CALL_ARGS:{let{delta:E}=c,p=n[n.length-1],l=p.toolCalls[p.toolCalls.length-1];if(l.function.arguments+=E,o){let d=o.find(h=>h.tool===l.function.name);if(d)try{let h=JSON.parse(Y(l.function.arguments));return d.tool_argument&&d.tool_argument in h?(r=_(x({},r),{[d.state_key]:h[d.tool_argument]}),i({messages:n,state:r})):(r=_(x({},r),{[d.state_key]:h}),i({messages:n,state:r}))}catch(h){}}return i({messages:n})}case S.TOOL_CALL_END:return s();case S.STATE_SNAPSHOT:{let{snapshot:E}=c;return r=E,i({state:r})}case S.STATE_DELTA:{let{delta:E}=c;try{return r=W(r,E,!0,!1).newDocument,i({state:r})}catch(p){let l=p instanceof Error?p.message:String(p);return console.warn(`Failed to apply state patch:
Current state: ${JSON.stringify(r,null,2)}
Patch operations: ${JSON.stringify(E,null,2)}
Error: ${l}`),s()}}case S.MESSAGES_SNAPSHOT:{let{messages:E}=c;return n=E,i({messages:n})}case S.RAW:return s();case S.CUSTOM:{let E=c;return E.name==="PredictState"&&(o=E.value),s()}case S.RUN_STARTED:return s();case S.RUN_FINISHED:return s();case S.RUN_ERROR:return s();case S.STEP_STARTED:return s();case S.STEP_FINISHED:return o=void 0,s()}let f=c.type;return s()}))};import{EventType as m,AGUIError as y}from"@ag-ui/core";import{throwError as T,of as L}from"rxjs";import{mergeMap as K}from"rxjs/operators";var O=u=>{let e,t,n=!1,r=!1,o=!1,i=new Map;return u.pipe(K(s=>{let c=s.type;if(r)return T(()=>new y(`Cannot send event type '${c}': The run has already errored with 'RUN_ERROR'. No further events can be sent.`));if(n&&c!==m.RUN_ERROR)return T(()=>new y(`Cannot send event type '${c}': The run has already finished with 'RUN_FINISHED'. Start a new run with 'RUN_STARTED'.`));if(e!==void 0&&![m.TEXT_MESSAGE_CONTENT,m.TEXT_MESSAGE_END,m.RAW].includes(c))return T(()=>new y(`Cannot send event type '${c}' after 'TEXT_MESSAGE_START': Send 'TEXT_MESSAGE_END' first.`));if(t!==void 0&&![m.TOOL_CALL_ARGS,m.TOOL_CALL_END,m.RAW].includes(c))return c===m.TOOL_CALL_START?T(()=>new y("Cannot send 'TOOL_CALL_START' event: A tool call is already in progress. Complete it with 'TOOL_CALL_END' first.")):T(()=>new y(`Cannot send event type '${c}' after 'TOOL_CALL_START': Send 'TOOL_CALL_END' first.`));if(o){if(c===m.RUN_STARTED)return T(()=>new y("Cannot send multiple 'RUN_STARTED' events: A 'RUN_STARTED' event was already sent. Each run must have exactly one 'RUN_STARTED' event at the beginning."))}else if(o=!0,c!==m.RUN_STARTED&&c!==m.RUN_ERROR)return T(()=>new y("First event must be 'RUN_STARTED'"));switch(c){case m.TEXT_MESSAGE_START:return e!==void 0?T(()=>new y("Cannot send 'TEXT_MESSAGE_START' event: A text message is already in progress. Complete it with 'TEXT_MESSAGE_END' first.")):(e=s.messageId,L(s));case m.TEXT_MESSAGE_CONTENT:return e===void 0?T(()=>new y("Cannot send 'TEXT_MESSAGE_CONTENT' event: No active text message found. Start a text message with 'TEXT_MESSAGE_START' first.")):s.messageId!==e?T(()=>new y(`Cannot send 'TEXT_MESSAGE_CONTENT' event: Message ID mismatch. The ID '${s.messageId}' doesn't match the active message ID '${e}'.`)):L(s);case m.TEXT_MESSAGE_END:return e===void 0?T(()=>new y("Cannot send 'TEXT_MESSAGE_END' event: No active text message found. A 'TEXT_MESSAGE_START' event must be sent first.")):s.messageId!==e?T(()=>new y(`Cannot send 'TEXT_MESSAGE_END' event: Message ID mismatch. The ID '${s.messageId}' doesn't match the active message ID '${e}'.`)):(e=void 0,L(s));case m.TOOL_CALL_START:return t!==void 0?T(()=>new y("Cannot send 'TOOL_CALL_START' event: A tool call is already in progress. Complete it with 'TOOL_CALL_END' first.")):(t=s.toolCallId,L(s));case m.TOOL_CALL_ARGS:return t===void 0?T(()=>new y("Cannot send 'TOOL_CALL_ARGS' event: No active tool call found. Start a tool call with 'TOOL_CALL_START' first.")):s.toolCallId!==t?T(()=>new y(`Cannot send 'TOOL_CALL_ARGS' event: Tool call ID mismatch. The ID '${s.toolCallId}' doesn't match the active tool call ID '${t}'.`)):L(s);case m.TOOL_CALL_END:return t===void 0?T(()=>new y("Cannot send 'TOOL_CALL_END' event: No active tool call found. A 'TOOL_CALL_START' event must be sent first.")):s.toolCallId!==t?T(()=>new y(`Cannot send 'TOOL_CALL_END' event: Tool call ID mismatch. The ID '${s.toolCallId}' doesn't match the active tool call ID '${t}'.`)):(t=void 0,L(s));case m.STEP_STARTED:{let f=s.name;return i.has(f)?T(()=>new y(`Step "${f}" is already active for 'STEP_STARTED'`)):(i.set(f,!0),L(s))}case m.STEP_FINISHED:{let f=s.name;return i.has(f)?(i.delete(f),L(s)):T(()=>new y(`Cannot send 'STEP_FINISHED' for step "${f}" that was not started`))}case m.RUN_STARTED:return L(s);case m.RUN_FINISHED:{if(i.size>0){let f=Array.from(i.keys()).join(", ");return T(()=>new y(`Cannot send 'RUN_FINISHED' while steps are still active: ${f}`))}return n=!0,L(s)}case m.RUN_ERROR:return r=!0,L(s);case m.CUSTOM:return L(s);default:return L(s)}}))};import{EventSchemas as ae}from"@ag-ui/core";import{Subject as oe,ReplaySubject as ce}from"rxjs";import{Observable as Q,from as Z,defer as ee,throwError as te}from"rxjs";import{switchMap as ne}from"rxjs/operators";var D=(u,e)=>ee(()=>Z(fetch(u,e))).pipe(ne(t=>{var o;let n={type:"headers",status:t.status,headers:t.headers},r=(o=t.body)==null?void 0:o.getReader();return r?new Q(i=>(i.next(n),(async()=>{try{for(;;){let{done:s,value:c}=await r.read();if(s)break;let f={type:"data",data:c};i.next(f)}i.complete()}catch(s){i.error(s)}})(),()=>{r.cancel()})):te(()=>new Error("Failed to getReader() from response"))}));import{Subject as se}from"rxjs";var w=u=>{let e=new se,t=new TextDecoder("utf-8",{fatal:!1}),n="";u.subscribe({next:o=>{if(o.type!=="headers"&&o.type==="data"&&o.data){let i=t.decode(o.data,{stream:!0});n+=i;let s=n.split(/\n\n/);n=s.pop()||"";for(let c of s)r(c)}},error:o=>e.error(o),complete:()=>{n&&(n+=t.decode(),r(n)),e.complete()}});function r(o){let i=o.split(`
`),s=[];for(let c of i)c.startsWith("data: ")&&s.push(c.slice(6));if(s.length>0)try{let c=s.join(`
`),f=JSON.parse(c);e.next(f)}catch(c){e.error(c)}}return e.asObservable()};import{Subject as re}from"rxjs";import*as X from"@ag-ui/proto";var H=u=>{let e=new re,t=new Uint8Array(0);u.subscribe({next:r=>{if(r.type!=="headers"&&r.type==="data"&&r.data){let o=new Uint8Array(t.length+r.data.length);o.set(t,0),o.set(r.data,t.length),t=o,n()}},error:r=>e.error(r),complete:()=>{if(t.length>0)try{n()}catch(r){console.warn("Incomplete or invalid protocol buffer data at stream end")}e.complete()}});function n(){for(;t.length>=4;){let i=4+new DataView(t.buffer,t.byteOffset,4).getUint32(0,!1);if(t.length<i)break;try{let s=t.slice(4,i),c=X.decode(s);e.next(c),t=t.slice(i)}catch(s){let c=s instanceof Error?s.message:String(s);e.error(new Error(`Failed to decode protocol buffer message: ${c}`));return}}}return e.asObservable()};import*as F from"@ag-ui/proto";var P=u=>{let e=new oe,t=new ce,n=!1;return u.subscribe({next:r=>{t.next(r),r.type==="headers"&&!n?(n=!0,r.headers.get("content-type")===F.AGUI_MEDIA_TYPE?H(t).subscribe({next:i=>e.next(i),error:i=>e.error(i),complete:()=>e.complete()}):w(t).subscribe({next:i=>{try{let s=ae.parse(i);e.next(s)}catch(s){e.error(s)}},error:i=>e.error(i),complete:()=>e.complete()})):n||e.error(new Error("No headers event received before data events"))},error:r=>{t.error(r),e.error(r)},complete:()=>{t.complete()}}),e.asObservable()};import{mergeMap as Te}from"rxjs/operators";import{applyPatch as Se}from"fast-json-patch";import{EventType as A}from"@ag-ui/core";import{z as a}from"zod";var g=a.enum(["TextMessageStart","TextMessageContent","TextMessageEnd","ActionExecutionStart","ActionExecutionArgs","ActionExecutionEnd","ActionExecutionResult","AgentStateMessage","MetaEvent","RunStarted","RunFinished","RunError","NodeStarted","NodeFinished"]),ie=a.enum(["LangGraphInterruptEvent","PredictState","Exit"]),le=a.object({type:a.literal(g.enum.TextMessageStart),messageId:a.string(),parentMessageId:a.string().optional()}),ue=a.object({type:a.literal(g.enum.TextMessageContent),messageId:a.string(),content:a.string()}),pe=a.object({type:a.literal(g.enum.TextMessageEnd),messageId:a.string()}),ge=a.object({type:a.literal(g.enum.ActionExecutionStart),actionExecutionId:a.string(),actionName:a.string(),parentMessageId:a.string().optional()}),Ee=a.object({type:a.literal(g.enum.ActionExecutionArgs),actionExecutionId:a.string(),args:a.string()}),me=a.object({type:a.literal(g.enum.ActionExecutionEnd),actionExecutionId:a.string()}),fe=a.object({type:a.literal(g.enum.ActionExecutionResult),actionName:a.string(),actionExecutionId:a.string(),result:a.string()}),de=a.object({type:a.literal(g.enum.AgentStateMessage),threadId:a.string(),agentName:a.string(),nodeName:a.string(),runId:a.string(),active:a.boolean(),role:a.string(),state:a.string(),running:a.boolean()}),ye=a.object({type:a.literal(g.enum.MetaEvent),name:ie,value:a.any()}),Ot=a.discriminatedUnion("type",[le,ue,pe,ge,Ee,me,fe,de,ye]),Nt=a.object({id:a.string(),role:a.string(),content:a.string(),parentMessageId:a.string().optional()}),It=a.object({id:a.string(),name:a.string(),arguments:a.any(),parentMessageId:a.string().optional()}),Dt=a.object({id:a.string(),result:a.any(),actionExecutionId:a.string(),actionName:a.string()});import Ae from"untruncate-json";var U=(u,e,t)=>n=>{let r={},o=!0,i=!0,s="",c=null,f=null,R=[],E=p=>{typeof p=="object"&&p!==null&&("messages"in p&&delete p.messages,r=p)};return n.pipe(Te(p=>{switch(p.type){case A.TEXT_MESSAGE_START:{let l=p;return[{type:g.enum.TextMessageStart,messageId:l.messageId}]}case A.TEXT_MESSAGE_CONTENT:{let l=p;return[{type:g.enum.TextMessageContent,messageId:l.messageId,content:l.delta}]}case A.TEXT_MESSAGE_END:{let l=p;return[{type:g.enum.TextMessageEnd,messageId:l.messageId}]}case A.TOOL_CALL_START:{let l=p;return R.push({id:l.toolCallId,type:"function",function:{name:l.toolCallName,arguments:""}}),i=!0,[{type:g.enum.ActionExecutionStart,actionExecutionId:l.toolCallId,actionName:l.toolCallName,parentMessageId:l.parentMessageId}]}case A.TOOL_CALL_ARGS:{let l=p,d=R[R.length-1];d.function.arguments+=l.delta;let h=!1;if(f){let M=f.find(C=>C.tool==d.function.name);if(M)try{let C=JSON.parse(Ae(d.function.arguments));M.tool_argument&&M.tool_argument in C?(E(_(x({},r),{[M.state_key]:C[M.tool_argument]})),h=!0):M.tool_argument||(E(_(x({},r),{[M.state_key]:C})),h=!0)}catch(C){}}return[{type:g.enum.ActionExecutionArgs,actionExecutionId:l.toolCallId,args:l.delta},...h?[{type:g.enum.AgentStateMessage,threadId:u,agentName:t,nodeName:s,runId:e,running:o,role:"assistant",state:JSON.stringify(r),active:i}]:[]]}case A.TOOL_CALL_END:{let l=p;return[{type:g.enum.ActionExecutionEnd,actionExecutionId:l.toolCallId}]}case A.RAW:return[];case A.CUSTOM:{let l=p;switch(l.name){case"Exit":o=!1;break;case"PredictState":f=l.value;break}return[{type:g.enum.MetaEvent,name:l.name,value:l.value}]}case A.STATE_SNAPSHOT:return E(p.snapshot),[{type:g.enum.AgentStateMessage,threadId:u,agentName:t,nodeName:s,runId:e,running:o,role:"assistant",state:JSON.stringify(r),active:i}];case A.STATE_DELTA:{let d=Se(r,p.delta,!0,!1);return d?(E(d.newDocument),[{type:g.enum.AgentStateMessage,threadId:u,agentName:t,nodeName:s,runId:e,running:o,role:"assistant",state:JSON.stringify(r),active:i}]):[]}case A.MESSAGES_SNAPSHOT:return c=p.messages,[{type:g.enum.AgentStateMessage,threadId:u,agentName:t,nodeName:s,runId:e,running:o,role:"assistant",state:JSON.stringify(x(x({},r),c?{messages:c}:{})),active:!0}];case A.RUN_STARTED:return[];case A.RUN_FINISHED:return c&&(r.messages=c),[{type:g.enum.AgentStateMessage,threadId:u,agentName:t,nodeName:s,runId:e,running:o,role:"assistant",state:JSON.stringify(x(x({},r),c?{messages:ve(c)}:{})),active:!1}];case A.RUN_ERROR:return console.error("Run error",p),[];case A.STEP_STARTED:return s=p.stepName,R=[],f=null,[{type:g.enum.AgentStateMessage,threadId:u,agentName:t,nodeName:s,runId:e,running:o,role:"assistant",state:JSON.stringify(r),active:!0}];case A.STEP_FINISHED:return R=[],f=null,[{type:g.enum.AgentStateMessage,threadId:u,agentName:t,nodeName:s,runId:e,running:o,role:"assistant",state:JSON.stringify(r),active:!1}];default:return[]}}))};function ve(u){var t;let e=[];for(let n of u)if(n.role==="assistant"||n.role==="user"||n.role==="system"){if(n.content){let r={id:n.id,role:n.role,content:n.content};e.push(r)}if(n.role==="assistant"&&n.toolCalls&&n.toolCalls.length>0)for(let r of n.toolCalls){let o={id:r.id,name:r.function.name,arguments:JSON.parse(r.function.arguments),parentMessageId:n.id};e.push(o)}}else if(n.role==="tool"){let r="unknown";for(let i of u)if(i.role==="assistant"&&((t=i.toolCalls)!=null&&t.length)){for(let s of i.toolCalls)if(s.id===n.toolCallId){r=s.function.name;break}}let o={id:n.id,result:n.content,actionExecutionId:n.toolCallId,actionName:r};e.push(o)}return e}import{v4 as N}from"uuid";import{catchError as xe,tap as Le}from"rxjs/operators";import{finalize as he}from"rxjs/operators";import{throwError as Re,pipe as _e}from"rxjs";import{lastValueFrom as Me,of as Ce}from"rxjs";var b=class{constructor({agentId:e,description:t,threadId:n,initialMessages:r,initialState:o}={}){this.agentId=e,this.description=t!=null?t:"",this.threadId=n!=null?n:N(),this.messages=v(r!=null?r:[]),this.state=v(o!=null?o:{})}async runAgent(e){var r;this.agentId=(r=this.agentId)!=null?r:N();let t=this.prepareRunAgentInput(e),n=_e(()=>this.run(t),O,o=>this.apply(t,o),o=>this.processApplyEvents(t,o),xe(o=>(this.onError(o),Re(()=>o))),he(()=>{this.onFinalize()}));return Me(n(Ce(null))).then(()=>{})}abortRun(){}apply(...e){return I(...e)}processApplyEvents(e,t){return t.pipe(Le(n=>{n.messages&&(this.messages=n.messages),n.state&&(this.state=n.state)}))}prepareRunAgentInput(e){var t,n,r;return{threadId:this.threadId,runId:(e==null?void 0:e.runId)||N(),tools:v((t=e==null?void 0:e.tools)!=null?t:[]),context:v((n=e==null?void 0:e.context)!=null?n:[]),forwardedProps:v((r=e==null?void 0:e.forwardedProps)!=null?r:{}),state:v(this.state),messages:v(this.messages)}}onError(e){console.error("Agent execution failed:",e)}onFinalize(){}clone(){let e=Object.create(Object.getPrototypeOf(this));for(let t of Object.getOwnPropertyNames(this)){let n=this[t];typeof n!="function"&&(e[t]=v(n))}return e}legacy_to_be_removed_runAgentBridged(e){var n;this.agentId=(n=this.agentId)!=null?n:N();let t=this.prepareRunAgentInput(e);return this.run(t).pipe(O,U(this.threadId,t.runId,this.agentId))}};var G=class extends b{constructor(t){var n;super(t);this.abortController=new AbortController;this.url=t.url,this.headers=v((n=t.headers)!=null?n:{})}requestInit(t){return{method:"POST",headers:_(x({},this.headers),{"Content-Type":"application/json",Accept:"text/event-stream"}),body:JSON.stringify(t),signal:this.abortController.signal}}runAgent(t){var n;return this.abortController=(n=t==null?void 0:t.abortController)!=null?n:new AbortController,super.runAgent(t)}abortRun(){this.abortController.abort(),super.abortRun()}run(t){let n=D(this.url,this.requestInit(t));return P(n)}};export*from"@ag-ui/core";export{b as AbstractAgent,G as HttpAgent,U as convertToLegacyEvents,I as defaultApplyEvents,H as parseProtoStream,w as parseSSEStream,D as runHttpRequest,P as transformHttpEventStream,O as verifyEvents};
//# sourceMappingURL=index.mjs.map