"use strict";var ue=Object.create;var N=Object.defineProperty,pe=Object.defineProperties,ge=Object.getOwnPropertyDescriptor,Ee=Object.getOwnPropertyDescriptors,me=Object.getOwnPropertyNames,q=Object.getOwnPropertySymbols,fe=Object.getPrototypeOf,W=Object.prototype.hasOwnProperty,de=Object.prototype.propertyIsEnumerable;var V=(o,e,t)=>e in o?N(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t,v=(o,e)=>{for(var t in e||(e={}))W.call(e,t)&&V(o,t,e[t]);if(q)for(var t of q(e))de.call(e,t)&&V(o,t,e[t]);return o},_=(o,e)=>pe(o,Ee(e));var ye=(o,e)=>{for(var t in e)N(o,t,{get:e[t],enumerable:!0})},w=(o,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of me(e))!W.call(o,s)&&s!==t&&N(o,s,{get:()=>e[s],enumerable:!(n=ge(e,s))||n.enumerable});return o},h=(o,e,t)=>(w(o,e,"default"),t&&w(t,e,"default")),H=(o,e,t)=>(t=o!=null?ue(fe(o)):{},w(e||!o||!o.__esModule?N(t,"default",{value:o,enumerable:!0}):t,o)),Te=o=>w(N({},"__esModule",{value:!0}),o);var L={};ye(L,{AbstractAgent:()=>O,HttpAgent:()=>J,convertToLegacyEvents:()=>F,defaultApplyEvents:()=>P,parseProtoStream:()=>j,parseSSEStream:()=>G,runHttpRequest:()=>U,transformHttpEventStream:()=>X,verifyEvents:()=>I});module.exports=Te(L);var T=require("@ag-ui/core"),Y=require("rxjs/operators");var A=o=>{if(typeof structuredClone=="function")return structuredClone(o);try{return JSON.parse(JSON.stringify(o))}catch(e){return v({},o)}};var K=require("fast-json-patch"),Q=H(require("untruncate-json"));var P=(...o)=>{let[e,t]=o,n=A(e.messages),s=A(e.state),c,l=i=>[A(i)],r=()=>[];return t.pipe((0,Y.mergeMap)(i=>{var R;switch(i.type){case T.EventType.TEXT_MESSAGE_START:{let{messageId:f,role:E}=i,p={id:f,role:E,content:""};return n.push(p),l({messages:n})}case T.EventType.TEXT_MESSAGE_CONTENT:{let{delta:f}=i,E=n[n.length-1];return E.content=E.content+f,l({messages:n})}case T.EventType.TEXT_MESSAGE_END:return r();case T.EventType.TOOL_CALL_START:{let{toolCallId:f,toolCallName:E,parentMessageId:p}=i,y;return p&&n.length>0&&n[n.length-1].id===p?y=n[n.length-1]:(y={id:p||f,role:"assistant",toolCalls:[]},n.push(y)),(R=y.toolCalls)!=null||(y.toolCalls=[]),y.toolCalls.push({id:f,type:"function",function:{name:E,arguments:""}}),l({messages:n})}case T.EventType.TOOL_CALL_ARGS:{let{delta:f}=i,E=n[n.length-1],p=E.toolCalls[E.toolCalls.length-1];if(p.function.arguments+=f,c){let y=c.find(x=>x.tool===p.function.name);if(y)try{let x=JSON.parse((0,Q.default)(p.function.arguments));return y.tool_argument&&y.tool_argument in x?(s=_(v({},s),{[y.state_key]:x[y.tool_argument]}),l({messages:n,state:s})):(s=_(v({},s),{[y.state_key]:x}),l({messages:n,state:s}))}catch(x){}}return l({messages:n})}case T.EventType.TOOL_CALL_END:return r();case T.EventType.STATE_SNAPSHOT:{let{snapshot:f}=i;return s=f,l({state:s})}case T.EventType.STATE_DELTA:{let{delta:f}=i;try{return s=(0,K.applyPatch)(s,f,!0,!1).newDocument,l({state:s})}catch(E){let p=E instanceof Error?E.message:String(E);return console.warn(`Failed to apply state patch:
Current state: ${JSON.stringify(s,null,2)}
Patch operations: ${JSON.stringify(f,null,2)}
Error: ${p}`),r()}}case T.EventType.MESSAGES_SNAPSHOT:{let{messages:f}=i;return n=f,l({messages:n})}case T.EventType.RAW:return r();case T.EventType.CUSTOM:{let f=i;return f.name==="PredictState"&&(c=f.value),r()}case T.EventType.RUN_STARTED:return r();case T.EventType.RUN_FINISHED:return r();case T.EventType.RUN_ERROR:return r();case T.EventType.STEP_STARTED:return r();case T.EventType.STEP_FINISHED:return c=void 0,r()}let d=i.type;return r()}))};var u=require("@ag-ui/core"),g=require("rxjs"),Z=require("rxjs/operators"),I=o=>{let e,t,n=!1,s=!1,c=!1,l=new Map;return o.pipe((0,Z.mergeMap)(r=>{let i=r.type;if(s)return(0,g.throwError)(()=>new u.AGUIError(`Cannot send event type '${i}': The run has already errored with 'RUN_ERROR'. No further events can be sent.`));if(n&&i!==u.EventType.RUN_ERROR)return(0,g.throwError)(()=>new u.AGUIError(`Cannot send event type '${i}': The run has already finished with 'RUN_FINISHED'. Start a new run with 'RUN_STARTED'.`));if(e!==void 0&&![u.EventType.TEXT_MESSAGE_CONTENT,u.EventType.TEXT_MESSAGE_END,u.EventType.RAW].includes(i))return(0,g.throwError)(()=>new u.AGUIError(`Cannot send event type '${i}' after 'TEXT_MESSAGE_START': Send 'TEXT_MESSAGE_END' first.`));if(t!==void 0&&![u.EventType.TOOL_CALL_ARGS,u.EventType.TOOL_CALL_END,u.EventType.RAW].includes(i))return i===u.EventType.TOOL_CALL_START?(0,g.throwError)(()=>new u.AGUIError("Cannot send 'TOOL_CALL_START' event: A tool call is already in progress. Complete it with 'TOOL_CALL_END' first.")):(0,g.throwError)(()=>new u.AGUIError(`Cannot send event type '${i}' after 'TOOL_CALL_START': Send 'TOOL_CALL_END' first.`));if(c){if(i===u.EventType.RUN_STARTED)return(0,g.throwError)(()=>new u.AGUIError("Cannot send multiple 'RUN_STARTED' events: A 'RUN_STARTED' event was already sent. Each run must have exactly one 'RUN_STARTED' event at the beginning."))}else if(c=!0,i!==u.EventType.RUN_STARTED&&i!==u.EventType.RUN_ERROR)return(0,g.throwError)(()=>new u.AGUIError("First event must be 'RUN_STARTED'"));switch(i){case u.EventType.TEXT_MESSAGE_START:return e!==void 0?(0,g.throwError)(()=>new u.AGUIError("Cannot send 'TEXT_MESSAGE_START' event: A text message is already in progress. Complete it with 'TEXT_MESSAGE_END' first.")):(e=r.messageId,(0,g.of)(r));case u.EventType.TEXT_MESSAGE_CONTENT:return e===void 0?(0,g.throwError)(()=>new u.AGUIError("Cannot send 'TEXT_MESSAGE_CONTENT' event: No active text message found. Start a text message with 'TEXT_MESSAGE_START' first.")):r.messageId!==e?(0,g.throwError)(()=>new u.AGUIError(`Cannot send 'TEXT_MESSAGE_CONTENT' event: Message ID mismatch. The ID '${r.messageId}' doesn't match the active message ID '${e}'.`)):(0,g.of)(r);case u.EventType.TEXT_MESSAGE_END:return e===void 0?(0,g.throwError)(()=>new u.AGUIError("Cannot send 'TEXT_MESSAGE_END' event: No active text message found. A 'TEXT_MESSAGE_START' event must be sent first.")):r.messageId!==e?(0,g.throwError)(()=>new u.AGUIError(`Cannot send 'TEXT_MESSAGE_END' event: Message ID mismatch. The ID '${r.messageId}' doesn't match the active message ID '${e}'.`)):(e=void 0,(0,g.of)(r));case u.EventType.TOOL_CALL_START:return t!==void 0?(0,g.throwError)(()=>new u.AGUIError("Cannot send 'TOOL_CALL_START' event: A tool call is already in progress. Complete it with 'TOOL_CALL_END' first.")):(t=r.toolCallId,(0,g.of)(r));case u.EventType.TOOL_CALL_ARGS:return t===void 0?(0,g.throwError)(()=>new u.AGUIError("Cannot send 'TOOL_CALL_ARGS' event: No active tool call found. Start a tool call with 'TOOL_CALL_START' first.")):r.toolCallId!==t?(0,g.throwError)(()=>new u.AGUIError(`Cannot send 'TOOL_CALL_ARGS' event: Tool call ID mismatch. The ID '${r.toolCallId}' doesn't match the active tool call ID '${t}'.`)):(0,g.of)(r);case u.EventType.TOOL_CALL_END:return t===void 0?(0,g.throwError)(()=>new u.AGUIError("Cannot send 'TOOL_CALL_END' event: No active tool call found. A 'TOOL_CALL_START' event must be sent first.")):r.toolCallId!==t?(0,g.throwError)(()=>new u.AGUIError(`Cannot send 'TOOL_CALL_END' event: Tool call ID mismatch. The ID '${r.toolCallId}' doesn't match the active tool call ID '${t}'.`)):(t=void 0,(0,g.of)(r));case u.EventType.STEP_STARTED:{let d=r.name;return l.has(d)?(0,g.throwError)(()=>new u.AGUIError(`Step "${d}" is already active for 'STEP_STARTED'`)):(l.set(d,!0),(0,g.of)(r))}case u.EventType.STEP_FINISHED:{let d=r.name;return l.has(d)?(l.delete(d),(0,g.of)(r)):(0,g.throwError)(()=>new u.AGUIError(`Cannot send 'STEP_FINISHED' for step "${d}" that was not started`))}case u.EventType.RUN_STARTED:return(0,g.of)(r);case u.EventType.RUN_FINISHED:{if(l.size>0){let d=Array.from(l.keys()).join(", ");return(0,g.throwError)(()=>new u.AGUIError(`Cannot send 'RUN_FINISHED' while steps are still active: ${d}`))}return n=!0,(0,g.of)(r)}case u.EventType.RUN_ERROR:return s=!0,(0,g.of)(r);case u.EventType.CUSTOM:return(0,g.of)(r);default:return(0,g.of)(r)}}))};var re=require("@ag-ui/core"),z=require("rxjs");var M=require("rxjs"),ee=require("rxjs/operators");var U=(o,e)=>(0,M.defer)(()=>(0,M.from)(fetch(o,e))).pipe((0,ee.switchMap)(t=>{var c;let n={type:"headers",status:t.status,headers:t.headers},s=(c=t.body)==null?void 0:c.getReader();return s?new M.Observable(l=>(l.next(n),(async()=>{try{for(;;){let{done:r,value:i}=await s.read();if(r)break;let d={type:"data",data:i};l.next(d)}l.complete()}catch(r){l.error(r)}})(),()=>{s.cancel()})):(0,M.throwError)(()=>new Error("Failed to getReader() from response"))}));var te=require("rxjs");var G=o=>{let e=new te.Subject,t=new TextDecoder("utf-8",{fatal:!1}),n="";o.subscribe({next:c=>{if(c.type!=="headers"&&c.type==="data"&&c.data){let l=t.decode(c.data,{stream:!0});n+=l;let r=n.split(/\n\n/);n=r.pop()||"";for(let i of r)s(i)}},error:c=>e.error(c),complete:()=>{n&&(n+=t.decode(),s(n)),e.complete()}});function s(c){let l=c.split(`
`),r=[];for(let i of l)i.startsWith("data: ")&&r.push(i.slice(6));if(r.length>0)try{let i=r.join(`
`),d=JSON.parse(i);e.next(d)}catch(i){e.error(i)}}return e.asObservable()};var ne=require("rxjs");var se=H(require("@ag-ui/proto")),j=o=>{let e=new ne.Subject,t=new Uint8Array(0);o.subscribe({next:s=>{if(s.type!=="headers"&&s.type==="data"&&s.data){let c=new Uint8Array(t.length+s.data.length);c.set(t,0),c.set(s.data,t.length),t=c,n()}},error:s=>e.error(s),complete:()=>{if(t.length>0)try{n()}catch(s){console.warn("Incomplete or invalid protocol buffer data at stream end")}e.complete()}});function n(){for(;t.length>=4;){let l=4+new DataView(t.buffer,t.byteOffset,4).getUint32(0,!1);if(t.length<l)break;try{let r=t.slice(4,l),i=se.decode(r);e.next(i),t=t.slice(l)}catch(r){let i=r instanceof Error?r.message:String(r);e.error(new Error(`Failed to decode protocol buffer message: ${i}`));return}}}return e.asObservable()};var ae=H(require("@ag-ui/proto")),X=o=>{let e=new z.Subject,t=new z.ReplaySubject,n=!1;return o.subscribe({next:s=>{t.next(s),s.type==="headers"&&!n?(n=!0,s.headers.get("content-type")===ae.AGUI_MEDIA_TYPE?j(t).subscribe({next:l=>e.next(l),error:l=>e.error(l),complete:()=>e.complete()}):G(t).subscribe({next:l=>{try{let r=re.EventSchemas.parse(l);e.next(r)}catch(r){e.error(r)}},error:l=>e.error(l),complete:()=>e.complete()})):n||e.error(new Error("No headers event received before data events"))},error:s=>{t.error(s),e.error(s)},complete:()=>{t.complete()}}),e.asObservable()};var oe=require("rxjs/operators"),ce=require("fast-json-patch"),S=require("@ag-ui/core");var a=require("zod"),m=a.z.enum(["TextMessageStart","TextMessageContent","TextMessageEnd","ActionExecutionStart","ActionExecutionArgs","ActionExecutionEnd","ActionExecutionResult","AgentStateMessage","MetaEvent","RunStarted","RunFinished","RunError","NodeStarted","NodeFinished"]),Se=a.z.enum(["LangGraphInterruptEvent","PredictState","Exit"]),Ae=a.z.object({type:a.z.literal(m.enum.TextMessageStart),messageId:a.z.string(),parentMessageId:a.z.string().optional()}),ve=a.z.object({type:a.z.literal(m.enum.TextMessageContent),messageId:a.z.string(),content:a.z.string()}),xe=a.z.object({type:a.z.literal(m.enum.TextMessageEnd),messageId:a.z.string()}),Le=a.z.object({type:a.z.literal(m.enum.ActionExecutionStart),actionExecutionId:a.z.string(),actionName:a.z.string(),parentMessageId:a.z.string().optional()}),he=a.z.object({type:a.z.literal(m.enum.ActionExecutionArgs),actionExecutionId:a.z.string(),args:a.z.string()}),Re=a.z.object({type:a.z.literal(m.enum.ActionExecutionEnd),actionExecutionId:a.z.string()}),_e=a.z.object({type:a.z.literal(m.enum.ActionExecutionResult),actionName:a.z.string(),actionExecutionId:a.z.string(),result:a.z.string()}),Me=a.z.object({type:a.z.literal(m.enum.AgentStateMessage),threadId:a.z.string(),agentName:a.z.string(),nodeName:a.z.string(),runId:a.z.string(),active:a.z.boolean(),role:a.z.string(),state:a.z.string(),running:a.z.boolean()}),Ce=a.z.object({type:a.z.literal(m.enum.MetaEvent),name:Se,value:a.z.any()}),yt=a.z.discriminatedUnion("type",[Ae,ve,xe,Le,he,Re,_e,Me,Ce]),Tt=a.z.object({id:a.z.string(),role:a.z.string(),content:a.z.string(),parentMessageId:a.z.string().optional()}),St=a.z.object({id:a.z.string(),name:a.z.string(),arguments:a.z.any(),parentMessageId:a.z.string().optional()}),At=a.z.object({id:a.z.string(),result:a.z.any(),actionExecutionId:a.z.string(),actionName:a.z.string()});var ie=H(require("untruncate-json"));var F=(o,e,t)=>n=>{let s={},c=!0,l=!0,r="",i=null,d=null,R=[],f=E=>{typeof E=="object"&&E!==null&&("messages"in E&&delete E.messages,s=E)};return n.pipe((0,oe.mergeMap)(E=>{switch(E.type){case S.EventType.TEXT_MESSAGE_START:{let p=E;return[{type:m.enum.TextMessageStart,messageId:p.messageId}]}case S.EventType.TEXT_MESSAGE_CONTENT:{let p=E;return[{type:m.enum.TextMessageContent,messageId:p.messageId,content:p.delta}]}case S.EventType.TEXT_MESSAGE_END:{let p=E;return[{type:m.enum.TextMessageEnd,messageId:p.messageId}]}case S.EventType.TOOL_CALL_START:{let p=E;return R.push({id:p.toolCallId,type:"function",function:{name:p.toolCallName,arguments:""}}),l=!0,[{type:m.enum.ActionExecutionStart,actionExecutionId:p.toolCallId,actionName:p.toolCallName,parentMessageId:p.parentMessageId}]}case S.EventType.TOOL_CALL_ARGS:{let p=E,y=R[R.length-1];y.function.arguments+=p.delta;let x=!1;if(d){let C=d.find(b=>b.tool==y.function.name);if(C)try{let b=JSON.parse((0,ie.default)(y.function.arguments));C.tool_argument&&C.tool_argument in b?(f(_(v({},s),{[C.state_key]:b[C.tool_argument]})),x=!0):C.tool_argument||(f(_(v({},s),{[C.state_key]:b})),x=!0)}catch(b){}}return[{type:m.enum.ActionExecutionArgs,actionExecutionId:p.toolCallId,args:p.delta},...x?[{type:m.enum.AgentStateMessage,threadId:o,agentName:t,nodeName:r,runId:e,running:c,role:"assistant",state:JSON.stringify(s),active:l}]:[]]}case S.EventType.TOOL_CALL_END:{let p=E;return[{type:m.enum.ActionExecutionEnd,actionExecutionId:p.toolCallId}]}case S.EventType.RAW:return[];case S.EventType.CUSTOM:{let p=E;switch(p.name){case"Exit":c=!1;break;case"PredictState":d=p.value;break}return[{type:m.enum.MetaEvent,name:p.name,value:p.value}]}case S.EventType.STATE_SNAPSHOT:return f(E.snapshot),[{type:m.enum.AgentStateMessage,threadId:o,agentName:t,nodeName:r,runId:e,running:c,role:"assistant",state:JSON.stringify(s),active:l}];case S.EventType.STATE_DELTA:{let y=(0,ce.applyPatch)(s,E.delta,!0,!1);return y?(f(y.newDocument),[{type:m.enum.AgentStateMessage,threadId:o,agentName:t,nodeName:r,runId:e,running:c,role:"assistant",state:JSON.stringify(s),active:l}]):[]}case S.EventType.MESSAGES_SNAPSHOT:return i=E.messages,[{type:m.enum.AgentStateMessage,threadId:o,agentName:t,nodeName:r,runId:e,running:c,role:"assistant",state:JSON.stringify(v(v({},s),i?{messages:i}:{})),active:!0}];case S.EventType.RUN_STARTED:return[];case S.EventType.RUN_FINISHED:return i&&(s.messages=i),[{type:m.enum.AgentStateMessage,threadId:o,agentName:t,nodeName:r,runId:e,running:c,role:"assistant",state:JSON.stringify(v(v({},s),i?{messages:be(i)}:{})),active:!1}];case S.EventType.RUN_ERROR:return console.error("Run error",E),[];case S.EventType.STEP_STARTED:return r=E.stepName,R=[],d=null,[{type:m.enum.AgentStateMessage,threadId:o,agentName:t,nodeName:r,runId:e,running:c,role:"assistant",state:JSON.stringify(s),active:!0}];case S.EventType.STEP_FINISHED:return R=[],d=null,[{type:m.enum.AgentStateMessage,threadId:o,agentName:t,nodeName:r,runId:e,running:c,role:"assistant",state:JSON.stringify(s),active:!1}];default:return[]}}))};function be(o){var t;let e=[];for(let n of o)if(n.role==="assistant"||n.role==="user"||n.role==="system"){if(n.content){let s={id:n.id,role:n.role,content:n.content};e.push(s)}if(n.role==="assistant"&&n.toolCalls&&n.toolCalls.length>0)for(let s of n.toolCalls){let c={id:s.id,name:s.function.name,arguments:JSON.parse(s.function.arguments),parentMessageId:n.id};e.push(c)}}else if(n.role==="tool"){let s="unknown";for(let l of o)if(l.role==="assistant"&&((t=l.toolCalls)!=null&&t.length)){for(let r of l.toolCalls)if(r.id===n.toolCallId){s=r.function.name;break}}let c={id:n.id,result:n.content,actionExecutionId:n.toolCallId,actionName:s};e.push(c)}return e}var D=require("uuid");var $=require("rxjs/operators"),le=require("rxjs/operators"),k=require("rxjs");var B=require("rxjs"),O=class{constructor({agentId:e,description:t,threadId:n,initialMessages:s,initialState:c}={}){this.agentId=e,this.description=t!=null?t:"",this.threadId=n!=null?n:(0,D.v4)(),this.messages=A(s!=null?s:[]),this.state=A(c!=null?c:{})}async runAgent(e){var s;this.agentId=(s=this.agentId)!=null?s:(0,D.v4)();let t=this.prepareRunAgentInput(e),n=(0,k.pipe)(()=>this.run(t),I,c=>this.apply(t,c),c=>this.processApplyEvents(t,c),(0,$.catchError)(c=>(this.onError(c),(0,k.throwError)(()=>c))),(0,le.finalize)(()=>{this.onFinalize()}));return(0,B.lastValueFrom)(n((0,B.of)(null))).then(()=>{})}abortRun(){}apply(...e){return P(...e)}processApplyEvents(e,t){return t.pipe((0,$.tap)(n=>{n.messages&&(this.messages=n.messages),n.state&&(this.state=n.state)}))}prepareRunAgentInput(e){var t,n,s;return{threadId:this.threadId,runId:(e==null?void 0:e.runId)||(0,D.v4)(),tools:A((t=e==null?void 0:e.tools)!=null?t:[]),context:A((n=e==null?void 0:e.context)!=null?n:[]),forwardedProps:A((s=e==null?void 0:e.forwardedProps)!=null?s:{}),state:A(this.state),messages:A(this.messages)}}onError(e){console.error("Agent execution failed:",e)}onFinalize(){}clone(){let e=Object.create(Object.getPrototypeOf(this));for(let t of Object.getOwnPropertyNames(this)){let n=this[t];typeof n!="function"&&(e[t]=A(n))}return e}legacy_to_be_removed_runAgentBridged(e){var n;this.agentId=(n=this.agentId)!=null?n:(0,D.v4)();let t=this.prepareRunAgentInput(e);return this.run(t).pipe(I,F(this.threadId,t.runId,this.agentId))}};var J=class extends O{constructor(t){var n;super(t);this.abortController=new AbortController;this.url=t.url,this.headers=A((n=t.headers)!=null?n:{})}requestInit(t){return{method:"POST",headers:_(v({},this.headers),{"Content-Type":"application/json",Accept:"text/event-stream"}),body:JSON.stringify(t),signal:this.abortController.signal}}runAgent(t){var n;return this.abortController=(n=t==null?void 0:t.abortController)!=null?n:new AbortController,super.runAgent(t)}abortRun(){this.abortController.abort(),super.abortRun()}run(t){let n=U(this.url,this.requestInit(t));return X(n)}};h(L,require("@ag-ui/core"),module.exports);0&&(module.exports={AbstractAgent,HttpAgent,convertToLegacyEvents,defaultApplyEvents,parseProtoStream,parseSSEStream,runHttpRequest,transformHttpEventStream,verifyEvents,...require("@ag-ui/core")});
//# sourceMappingURL=index.js.map